<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.9/angular.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.2.15/angular-ui-router.js"></script>

<html ng-app="app">
<div ui-view></div>

<center>
    <div ng-show="loading" style="font-size:25px; color:blue;">&nbsp
        Loading...
    </div>
    <div ng-show="error" style="font-size:25px; color:red;">
        Something went wrong
    </div>
</center>
</html>

<script>
    (function () {
        angular
			.module('app', ['ui.router']);

        angular
			.module('app')
			.config(routeConfig);
				
		routeConfig.$inject = ['$stateProvider', '$urlRouterProvider'];
		
        function routeConfig($stateProvider, $urlRouterProvider) {
            $urlRouterProvider.otherwise('/users');
            $stateProvider
				.state('users', {
					url: '/users',
							 template: '<div><center>' +
							'<h1>Auth</h1>' + 
							'<hr>' +
							'<button ng-click="collectionCtrl.getToken()">Get Token</button>&nbsp' +							
							'<button ng-click="collectionCtrl.getUsers()">Get Users</button>&nbsp' +
							'<hr>' +
							'<table border=1>' +
							'<tr ng-repeat="item in collectionCtrl.items">' +

							'<td>{{item.id}}</td>' +
							'<td>{{item.name}}</td>' +
							'<td>{{item.phone}}</td>' +

							'</tr>' +
							'</table>' +
							'</div>',
							controller: 'CollectionCtrl',
							controllerAs: 'collectionCtrl'
				})
        }

        angular
			.module('app')
			.controller('CollectionCtrl', CollectionCtrl);
				
		CollectionCtrl.$inject = ['$scope','$state', '$rootScope', '$http'];
		
        function CollectionCtrl($scope, $state, $rootScope, $http) {
            var vm = this;
			
			angular.extend(vm, {
				init: init,
				editItem: editItem,
				getUsers: getUsers,
				getToken: getToken,				
			});
			
			init();
			
			function init() {
				vm.items = [];
			}

            function editItem(item) {
				var url, api;
				api = 'api/clients/update';
				if ($rootScope.mode == 'Heroku') {
					url = $rootScope.myConfig.heroku + api;
				} else {
					url = $rootScope.myConfig.local + api;
				}

                var item = {
                    "id": item.id,
					"name": item.name + '_Updated',
					"pic": item.pic
                };
                $http.post(url, item)
                        .then(function (data) {
                            console.log(data);				
							$rootScope.$broadcast('resetOptions');							
                            $state.go('root');
                        })
                        .catch(function (data) {
                            console.log('catch - ' + data.status);
                        });
            }
			
            function getUsers() {
				$http.get('http://localhost:3000/api/users/get',
					{
						headers: {'Authorization': $rootScope.access_token}
					})
					.then(function (results) {
						vm.items = results.data;
						console.log(results);
					})
					.catch(function (error) {
						console.log('catch - ' + error.status);
						console.log(error);
					});
			}			
			            
			function getToken() {
				$http.get('http://localhost:3000/api/auth')
					.then(function (results) {
						$rootScope.access_token = results.data;
						console.log(results);
					})
					.catch(function (error) {
						console.log('catch - ' + error.status);
						console.log(error);
					});
			}	
		}
		
    })();
</script>